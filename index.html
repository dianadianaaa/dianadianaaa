<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kalkulator Green Now</title>
    <style>
        /* Twoje style CSS bez zmian */
    </style>
</head>
<body>
    <script>
    // === PANEL KONTROLNY ===
    const USTAWIENIA_GLOBALNE = {
        'nadprowizja-dyrektora': 0,
        'nadprowizja-kierownika': 0,
        'nadprowizja-firmy': 0,
        'marza-widocznosc': 90
    };
    // ========================

    const SCRIPT_URL_DO_DANYCH = "https://script.google.com/macros/s/AKfycbyCLFspt4Kuzqyj3tvNxqhDDD1kmXDF6tpfQCX0SI3xOqpsiT7--6CKm2i_Q2Tligz17g/exec";
    const POPRAWNE_HASLO = "ZielonaEnergia2025";

    let daneOferty = {};
    let aktywnaListaId = null;
    let numerZapisanejOferty = null;
    
    // Wszystkie funkcje (przejdzDoEtapu, BAZA_PRODUKTOW_UI, aktualizujPodsumowanieWizualne, itp.)
    // ...

    function zapiszOferteWArkuzu(dane) {
        // === NOWY KOMUNIKAT TESTOWY ===
        alert("TEST: Próbuję zapisać dane pod adresem URL:\n\n" + https://script.google.com/macros/s/AKfycbyCLFspt4Kuzqyj3tvNxqhDDD1kmXDF6tpfQCX0SI3xOqpsiT7--6CKm2i_Q2Tligz17g/exec);
        // ==============================

        if (!SCRIPT_URL_DO_DANYCH || SCRIPT_URL_DO_DANYCH.includes("https://script.google.com/macros/s/AKfycbyCLFspt4Kuzqyj3tvNxqhDDD1kmXDF6tpfQCX0SI3xOqpsiT7--6CKm2i_Q2Tligz17g/exec")) {
            console.log("Zapis do arkusza pominięty - brak poprawnego URL skryptu.");
            return;
        }
        const daneDoZapisu = {
            action: 'saveOffer',
            numerOferty: numerZapisanejOferty,
            dataWygenerowania: new Date().toISOString(),
            klient: `${dane.klient.imie}, ${dane.klient.adres}, ${dane.klient.kod}`,
            handlowiec: dane.handlowiec.imie,
            kwotaNetto: dane.obliczenia.sumaNettoFinal,
            kwotaBrutto: dane.obliczenia.cenaKoncowa,
            produkty: zbierzOpisProduktow(dane),
            marzaHandlowca: dane.obliczenia.marzaDlaPH,
            marzaDlaFirmy: dane.obliczenia.marzaDlaFirmy,
            nadprowizjaDyrektora: dane.nadprowizje.dyrektor,
            nadprowizjaKierownika: dane.nadprowizje.kierownik,
            nadprowizjaFirmy: dane.nadprowizje.firma
        };
        fetch(SCRIPT_URL_DO_DANYCH, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(daneDoZapisu)
        })
        .then(response => response.json())
        .then(data => {
            if (data.result !== "success") {
                 console.error("Błąd zapisu w Arkuszu:", data.message);
                 alert("Wystąpił błąd podczas zapisu oferty do Arkusza.");
            } else {
                console.log("Oferta zapisana pomyślnie w Arkuszu Google.");
                alert("Sukces! Dane oferty zostały zapisane w Arkuszu Google.");
            }
        })
        .catch(error => {
            console.error("Krytyczny błąd wysyłania danych:", error);
            alert(`Wystąpił krytyczny błąd podczas zapisu do Arkusza Google.`);
        });
    }

    // ... reszta funkcji i event listenery
</script>
</body>
</html>
