<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Green Now</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/vfs_fonts.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .kontener { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        .login-kontener { align-self: center; }
        h1, h2, h3 { color: #005b41; text-align: center; }
        h1 { font-size: 1.8em; margin-bottom: 30px; }
        h2 { font-size: 1.5em; margin-bottom: 25px; }
        h3 { font-size: 1.2em; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .etap { border: none; padding-top: 10px; margin-top: 10px; }
        label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; background-color: #f9f9f9; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus { border-color: #008170; outline: none; box-shadow: 0 0 0 3px rgba(0, 129, 112, 0.15); }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        button { background-color: #008170; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 30px; font-weight: bold; width: 100%; transition: background-color 0.3s, transform 0.1s; }
        button:hover { background-color: #005b41; }
        button:active { transform: scale(0.98); }
        .form-buttons { display: flex; gap: 10px; margin-top: 30px; }
        .form-buttons button { width: 100%; margin-top: 0; }
        button.wstecz { background-color: #6c757d; }
        button.wstecz:hover { background-color: #5a6268; }
        #przycisk-pdf-klient { background-color: #239d60; }
        #przycisk-pdf-klient:hover { background-color: #1a7448; }
        #przycisk-pdf-biuro { background-color: #555; }
        #przycisk-pdf-biuro:hover { background-color: #333; }
        .ukryty { display: none; }
        #stale-podsumowanie { border: 2px solid #008170; border-radius: 8px; margin-top: 40px; padding: 20px; background-color: #fafffd; }
        #lista-wybranych-elementow { list-style-type: none; padding-left: 0; margin-bottom: 20px; }
        #lista-wybranych-elementow li { background-color: #e8f5e9; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 0.9em; }
        #podsumowanie-tresc p { font-size: 1em; padding: 8px 5px; border-bottom: 1px solid #eee; margin: 0; display: flex; justify-content: space-between; align-items: center; }
        #podsumowanie-tresc p:last-child { border-bottom: none; }
        #podsumowanie-tresc span { font-weight: bold; }
        #cena-koncowa { color: #008170; font-size: 1.7em; font-weight: bold; }
        #stale-podsumowanie h3#cena-koncowa-naglowek { text-align: center; font-size: 1.3em; margin-top: 25px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <!-- LOGOWANIE -->
    <div id="prosty-login" class="kontener login-kontener">
        <h2>Dostęp do kalkulatora</h2>
        <label for="haslo-dostepu">Wprowadź hasło:</label>
        <input type="password" id="haslo-dostepu">
        <button id="przycisk-zaloguj">Odblokuj</button>
        <p id="login-error-prosty" style="color: red; text-align: center; height: 20px;"></p>
    </div>

    <!-- GŁÓWNY KALKULATOR -->
    <div id="glowny-kalkulator" class="kontener ukryty">
        <div id="etapy-kontener">
            <!-- Etap 1 -->
            <div id="etap1" class="etap">
                <h1>Etap 1: Konfiguracja Instalacji</h1>
                <label for="typ-instalacji">Typ instalacji:</label>
                <select id="typ-instalacji">
                    <option value="nowa">Nowa instalacja</option>
                    <option value="dokladka">Dokładka instalacji</option>
                </select>
                <h3>Wybór zestawu instalacji fotowoltaicznej</h3>
                <label for="typ-pokrycia">System montażowy:</label>
                <select id="typ-pokrycia">
                    <option value="">-- wybierz system --</option>
                    <option value="TRAPEZ">TRAPEZ</option>
                    <option value="DACHÓWKA">DACHÓWKA</option>
                    <option value="BLACHODACHÓWKA">BLACHODACHÓWKA</option>
                    <option value="EKIERKI">EKIERKI INWAZYJNE</option>
                    <option value="GRUNT">GRUNT</option>
                </select>
                <label for="zestaw-sieciowy">Zestawy Sieciowe:</label>
                <select id="zestaw-sieciowy" class="lista-produktow" disabled>
                    <option value="0" data-price="0">--</option>
                </select>
                <label for="zestaw-niskonapieciowy">Zestawy z Magazynem Niskonapięciowym:</label>
                <select id="zestaw-niskonapieciowy" class="lista-produktow" disabled>
                    <option value="0" data-price="0">--</option>
                </select>
                <label for="zestaw-wysokonapieciowy">Zestawy z Magazynem Wysokonapięciowym:</label>
                <select id="zestaw-wysokonapieciowy" class="lista-produktow" disabled>
                    <option value="0" data-price="0">--</option>
                </select>
                <button onclick="przejdzDoEtapu(2)">Dalej &rarr;</button>
            </div>

            <!-- Etap 2 -->
            <div id="etap2" class="etap ukryty">
                <h2>Krok 2: Produkty i prace dodatkowe</h2>
                <div id="opcje-magazynu-niskonapieciowego">
                    <label for="magazyn-niskonapieciowy">Dodatkowy magazyn niskonapięciowy:</label>
                    <select id="magazyn-niskonapieciowy">
                        <option value="0" data-price="0">-- Wybierz --</option>
                        <option value="10kwh" data-price="3000">10 kWh</option>
                        <option value="15kwh" data-price="5200">15 kWh</option>
                    </select>
                </div>
                <div id="opcje-magazynu-wysokonapieciowego">
                    <label for="magazyn-wysokonapieciowy">Dodatkowy magazyn wysokonapięciowy:</label>
                    <select id="magazyn-wysokonapieciowy">
                        <option value="0" data-price="0">-- Wybierz --</option>
                        <option value="14kwh" data-price="2900">14,21 kWh</option>
                        <option value="17kwh" data-price="5800">17,76 kWh</option>
                    </select>
                </div>
                <h3>Inne dodatki</h3>
                <label for="dodatki-magazyn">Bufor ciepła:</label>
                <select id="dodatki-magazyn">
                    <option value="0" data-price="0">Brak</option>
                    <option value="bufor_100l" data-price="1800">Bufor 100 l</option>
                </select>
                <label for="dodatki-moduly">Dokładka modułów:</label>
                <select id="dodatki-moduly">
                    <option value="0" data-price="0">Brak</option>
                    <option value="2szt" data-price="2500">2 szt.</option>
                    <option value="3szt" data-price="3000">3 szt.</option>
                    <option value="4szt" data-price="3500">4 szt.</option>
                </select>
                <div class="form-buttons">
                    <button onclick="przejdzDoEtapu(1)" class="wstecz">&larr; Wstecz</button>
                    <button onclick="przejdzDoEtapu(3)">Dalej &rarr;</button>
                </div>
            </div>

            <!-- Etap 3 -->
            <div id="etap3" class="etap ukryty">
                <h2>Krok 3: Prace ziemne i dodatkowe</h2>
                <label for="przekop">Przekop z kablem:</label>
                <select id="przekop">
                    <option value="brak" data-price="0">-- Brak --</option>
                    <option value="do10" data-price-per-meter="0" data-price="0">Przekop z kablem do 10 m</option>
                    <option value="10-30" data-price-per-meter="30">Przekop 10–30 m (30 zł/m)</option>
                    <option value="30-60" data-price-per-meter="35">Przekop 30–60 m (35 zł/m)</option>
                    <option value="powyzej60" data-price-per-meter="0" data-price="0">Przekop powyżej 60 m (wycena indywidualna)</option>
                </select>
                <div id="dlugosc-przekopu-kontener" class="ukryty">
                    <label for="dlugosc-przekopu">Długość przekopu (w metrach):</label>
                    <input type="number" id="dlugosc-przekopu" min="0" value="0">
                </div>
                <label for="klimatyzacja">Klimatyzacja:</label>
                <select id="klimatyzacja">
                    <option value="0" data-price="0">-- Wybierz --</option>
                    <option value="klima_2_6" data-price="3330">Klimatyzacja TCL Ocarina 2,6kW</option>
                    <option value="klima_3_4" data-price="3420">Klimatyzacja TCL Ocarina 3,4kW</option>
                    <option value="klima_5_1" data-price="4120">Klimatyzacja TCL Ocarina 5,1kW</option>
                    <option value="klima_6_8" data-price="4500">Klimatyzacja TCL Ocarina 6,8kW</option>
                </select>
                <label for="falownik-magazyn">Falownik + Magazyn energii:</label>
                <select id="falownik-magazyn">
                    <option value="0" data-price="0">-- Wybierz --</option>
                    <option value="falownik_lv_10" data-price="21900">Falownik LV (GoodWe 10) + magazyn 10kWh</option>
                    <option value="falownik_lv_5" data-price="18600">Falownik LV (Deye 5) + magazyn 5kWh</option>
                    <option value="falownik_hv_10" data-price="20900">Falownik HV (Deye 10) + magazyn 10kWh</option>
                </select>
                <label for="inne-dodatki-nazwa">Inne dodatki (nazwa):</label>
                <input type="text" id="inne-dodatki-nazwa" placeholder="Np. Dodatkowe zabezpieczenia">
                <label for="inne-dodatki-cena">Inne dodatki (kwota w PLN):</label>
                <input type="number" id="inne-dodatki-cena" min="0" value="0">
                <div class="form-buttons">
                    <button onclick="przejdzDoEtapu(2)" class="wstecz">&larr; Wstecz</button>
                    <button onclick="przejdzDoEtapu(4)">Generuj ofertę &rarr;</button>
                </div>
            </div>

            <!-- Etap 4 -->
            <div id="etap4" class="etap ukryty">
                <h2>Krok 4: Dane do oferty</h2>
                <div id="formularz-danych">
                    <h3>Dane Klienta</h3>
                    <input type="text" id="klient-imie" placeholder="Imię i nazwisko" required>
                    <input type="text" id="klient-adres" placeholder="Adres montażu" required>
                    <input type="text" id="klient-kod" placeholder="Kod pocztowy i miejscowość" required>
                    <input type="tel" id="klient-telefon" placeholder="Telefon" required>
                    <input type="email" id="klient-email" placeholder="E-mail" required>
                    <h3>Dane Handlowca</h3>
                    <input type="text" id="ph-imie" placeholder="Imię i nazwisko handlowca" required>
                    <input type="tel" id="ph-telefon" placeholder="Telefon handlowca" required>
                    <input type="email" id="ph-email" placeholder="E-mail handlowca" required>
                    <input type="text" id="ph-teren" placeholder="Teren działania" required>
                    <div class="form-buttons">
                        <button type="button" onclick="przejdzDoEtapu(3)" class="wstecz">&larr; Wstecz</button>
                        <button type="button" id="przycisk-pdf-klient">Generuj ofertę dla Klienta</button>
                        <button type="button" id="przycisk-pdf-biuro">Generuj podsumowanie dla Biura</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PODSUMOWANIE BOCZNE -->
        <div id="stale-podsumowanie">
            <h3>Wybrane elementy:</h3>
            <ul id="lista-wybranych-elementow"></ul>
            <h3>Podsumowanie Ceny:</h3>
            <div id="podsumowanie-tresc">
                <p>Koszt Bazowy (dla firmy): <span id="koszt-bazowy">0.00</span> PLN</p>
                <p>Marża Handlowca (widoczna): <span id="wartosc-marzy">0.00</span> PLN</p>
                <p>Wartość Netto (z marżą): <span id="suma-netto-final">0.00</span> PLN</p>
                <p>Podatek VAT: <span id="kwota-vat">0.00</span> PLN</p>
            </div>
            <label for="stawka-vat">Stawka VAT:</label>
            <select id="stawka-vat">
                <option value="0.08">8%</option>
                <option value="0.23" selected>23%</option>
            </select>
            <label for="marza-procent">Marża (% od Kosztu Bazowego):</label>
            <input type="number" id="marza-procent" min="0" value="0">
            <h3 id="cena-koncowa-naglowek">Cena końcowa dla klienta (Brutto): <span id="cena-koncowa">0.00 PLN</span></h3>
        </div>
    </div>

<script>
    const USTAWIENIA_GLOBALNE = {
        'nadprowizja-dyrektora': 0,
        'nadprowizja-kierownika': 0,
        'nadprowizja-firmy': 0,
        'marza-widocznosc': 90
    };
    const POPRAWNE_HASLO = "ZielonaEnergia2025";
    const SCRIPT_URL_DO_DANYCH = "https://script.google.com/macros/s/AKfycbztG4_6ynNvUIuRtiMIRX5I0SBHjF5sMdlnA6oe7oiaC6TxxPb9_eGZ2DBGHz-r9UEA/exec";

    let daneOferty = {};
    let aktywnaListaId = null;
    let numerZapisanejOferty = null;

    const BAZA_PRODUKTOW_UI = {
        "zestawy_sieciowe": {
            "TRAPEZ":[ {"name":"TRAPEZ ZESTAW 2,625 KWP LONGI 525 + Deye SUN-3K-G 1F","price":15140.00}, /* ... wszystkie pozostałe ... */ {"name":"TRAPEZ ZESTAW 15,225 KWP LONGI 525 + DEYE SUN-10K-G09","price":32000.00} ],
            "BLACHODACHÓWKA":[ /* … */ ],
            "DACHÓWKA":[ /* … */ ],
            "EKIERKI":[ /* … */ ],
            "GRUNT":[ /* … */ ]
        },
        "zestawy_niskonapieciowe": { /* … */ },
        "zestawy_wysokonapieciowe": { /* … */ }
    };

    function przejdzDoEtapu(nr) {
        document.querySelectorAll('#etapy-kontener .etap').forEach(e=>e.classList.add('ukryty'));
        document.getElementById('etap'+nr).classList.remove('ukryty');
    }

    function wypelnijListe(sel, kat, typ) {
        const st = sel.value;
        sel.innerHTML = '<option value="0" data-price="0">-- Wybierz --</option>';
        const p = (BAZA_PRODUKTOW_UI[kat]||{})[typ]||[];
        if(p.length){ sel.disabled=false; p.forEach(o=>{ const op = new Option(o.name,o.name); op.dataset.price=o.price; sel.add(op); }); }
        else { sel.disabled=true; sel.innerHTML='<option value="0" data-price="0">-- Brak produktów --</option>'; }
        sel.value=st;
    }

    function odswiezWszystkieListy() {
        const typ=document.getElementById('typ-pokrycia').value;
        if(!typ) document.querySelectorAll('.lista-produktow').forEach(s=>{ s.disabled=true; s.innerHTML='<option value="0" data-price="0">--</option>'; });
        else {
            wypelnijListe(document.getElementById('zestaw-sieciowy'),'zestawy_sieciowe',typ);
            wypelnijListe(document.getElementById('zestaw-niskonapieciowy'),'zestawy_niskonapieciowe',typ);
            wypelnijListe(document.getElementById('zestaw-wysokonapieciowy'),'zestawy_wysokonapieciowe',typ);
        }
    }

    function zbierzOpisProduktow(d) {
        const arr=[];
        if(d.zestawPV.text) arr.push(d.zestawPV.text);
        if(d.magazynNisko.text) arr.push(`Dod. magazyn NN: ${d.magazynNisko.text}`);
        if(d.magazynWysoko.text) arr.push(`Dod. magazyn WN: ${d.magazynWysoko.text}`);
        if(d.dodatkiMagazyn.text) arr.push(`Bufor: ${d.dodatkiMagazyn.text}`);
        if(d.dodatkiModuly.text) arr.push(`Moduły: ${d.dodatkiModuly.text}`);
        if(d.przekop.value!=='brak' && d.przekop.length>0) arr.push(`Przekop: ${d.przekop.length}m`);
        if(d.klimatyzacja.text) arr.push(d.klimatyzacja.text);
        if(d.falownikMagazyn.text) arr.push(d.falownikMagazyn.text);
        if(d.inneDodatki.cena>0) arr.push(d.inneDodatki.nazwa||'Inne dodatki');
        return arr.join('; ');
    }

    function aktualizujPodsumowanieWizualne(){
        numerZapisanejOferty=null;
        const gp = el=> el&&el.selectedIndex>0?parseFloat(el.options[el.selectedIndex].dataset.price):0;
        const gt = el=> el&&el.selectedIndex>0?el.options[el.selectedIndex].text:"";
        let wy={text:"",price:0};
        if(aktywnaListaId){ const s=document.getElementById(aktywnaListaId); wy={text:gt(s),price:gp(s)}; }
        daneOferty={
            zestawPV:wy,
            magazynNisko:{text:gt(document.getElementById('magazyn-niskonapieciowy')),price:gp(document.getElementById('magazyn-niskonapieciowy'))},
            magazynWysoko:{text:gt(document.getElementById('magazyn-wysokonapieciowy')),price:gp(document.getElementById('magazyn-wysokonapieciowy'))},
            dodatkiMagazyn:{text:gt(document.getElementById('dodatki-magazyn')),price:gp(document.getElementById('dodatki-magazyn'))},
            dodatkiModuly:{text:gt(document.getElementById('dodatki-moduly')),price:gp(document.getElementById('dodatki-moduly'))},
            przekop:{
                text:document.getElementById('przekop').options[document.getElementById('przekop').selectedIndex].text,
                value:document.getElementById('przekop').value,
                pricePerMeter:parseFloat(document.getElementById('przekop').options[document.getElementById('przekop').selectedIndex].dataset.pricePerMeter)||0,
                length:parseFloat(document.getElementById('dlugosc-przekopu').value)||0
            },
            klimatyzacja:{text:gt(document.getElementById('klimatyzacja')),price:gp(document.getElementById('klimatyzacja'))},
            falownikMagazyn:{text:gt(document.getElementById('falownik-magazyn')),price:gp(document.getElementById('falownik-magazyn'))},
            inneDodatki:{nazwa:document.getElementById('inne-dodatki-nazwa').value,cena:parseFloat(document.getElementById('inne-dodatki-cena').value)||0},
            stawkaVat:parseFloat(document.getElementById('stawka-vat').value),
            marzaProcent:parseFloat(document.getElementById('marza-procent').value)||0,
            klient:{
                imie:document.getElementById('klient-imie').value,
                adres:document.getElementById('klient-adres').value,
                kod:document.getElementById('klient-kod').value,
                telefon:document.getElementById('klient-telefon').value,
                email:document.getElementById('klient-email').value
            },
            handlowiec:{
                imie:document.getElementById('ph-imie').value,
                telefon:document.getElementById('ph-telefon').value,
                email:document.getElementById('ph-email').value,
                teren:document.getElementById('ph-teren').value
            },
            nadprowizje:{
                dyrektor:USTAWIENIA_GLOBALNE['nadprowizja-dyrektora'],
                kierownik:USTAWIENIA_GLOBALNE['nadprowizja-kierownika'],
                firma:USTAWIENIA_GLOBALNE['nadprowizja-firmy']
            },
            ustawieniaMarzy:{widocznosc:USTAWIENIA_GLOBALNE['marza-widocznosc']}
        };

        const kPod = daneOferty.zestawPV.price
            + daneOferty.magazynNisko.price
            + daneOferty.magazynWysoko.price
            + daneOferty.dodatkiMagazyn.price
            + daneOferty.dodatkiModuly.price
            + (daneOferty.przekop.pricePerMeter * daneOferty.przekop.length)
            + daneOferty.klimatyzacja.price
            + daneOferty.falownikMagazyn.price
            + daneOferty.inneDodatki.cena;
        const sumaNad = daneOferty.nadprowizje.dyrektor + daneOferty.nadprowizje.kierownik + daneOferty.nadprowizje.firma;
        const kosztBaz = kPod + sumaNad;
        const wartMarz = kosztBaz * (daneOferty.marzaProcent/100);
        const marzPH = wartMarz * (daneOferty.ustawieniaMarzy.widocznosc/100);
        const sumaNet = kosztBaz + wartMarz;
        const vat = sumaNet * daneOferty.stawkaVat;
        const brutto = sumaNet + vat;

        daneOferty.obliczenia = { kosztBazowy: kosztBaz, sumaNettoFinal: sumaNet, kwotaVat: vat, cenaKoncowa: brutto, marzaDlaPH: marzPH, marzaDlaFirmy: wartMarz - marzPH };

        document.getElementById('koszt-bazowy').textContent = kosztBaz.toFixed(2);
        document.getElementById('wartosc-marzy').textContent = marzPH.toFixed(2);
        document.getElementById('suma-netto-final').textContent = sumaNet.toFixed(2);
        document.getElementById('kwota-vat').textContent = vat.toFixed(2);
        document.getElementById('cena-koncowa').textContent = brutto.toFixed(2);
        document.getElementById('dlugosc-przekopu-kontener').classList.toggle('ukryty', daneOferty.przekop.pricePerMeter <= 0);

        const lista = document.getElementById('lista-wybranych-elementow');
        lista.innerHTML = '';
        const dodaj = (e,w) => {
            if(w && w!=='Brak' && w!=='-- Wybierz --' && w!=='--' && w!==0){
                const li = document.createElement('li');
                li.textContent = typeof w==='number' ? `${e}: ${w.toFixed(2)} PLN` : `${e}: ${w}`;
                lista.appendChild(li);
            }
        };
        dodaj('Zestaw główny', daneOferty.zestawPV.text);
        dodaj('Dod. magazyn NN', daneOferty.magazynNisko.text);
        dodaj('Dod. magazyn WN', daneOferty.magazynWysoko.text);
        dodaj('Bufor ciepła', daneOferty.dodatkiMagazyn.text);
        dodaj('Dodatkowe moduły', daneOferty.dodatkiModuly.text);
        if(daneOferty.przekop.value!=='brak') dodaj('Prace ziemne', daneOferty.przekop.text);
        dodaj('Klimatyzacja', daneOferty.klimatyzacja.text);
        dodaj('Dod. Falownik+Magazyn', daneOferty.falownikMagazyn.text);
        if(daneOferty.inneDodatki.cena>0) dodaj(daneOferty.inneDodatki.nazwa||'Inne dodatki', daneOferty.inneDodatki.cena);
    }

    function zapiszOferteWArkuzu(dane){
        console.log("→ wywołanie zapisu:", dane);
        fetch(SCRIPT_URL_DO_DANYCH, {
            method:'POST', mode:'cors',
            headers:{'Content-Type':'application/json;charset=UTF-8'},
            body:JSON.stringify({
                action:'saveOffer',
                numerOferty:numerZapisanejOferty,
                dataWygenerowania:new Date().toISOString(),
                klient:`${dane.klient.imie}, ${dane.klient.adres}, ${dane.klient.kod}`,
                handlowiec:dane.handlowiec.imie,
                kwotaNetto:dane.obliczenia.sumaNettoFinal,
                kwotaBrutto:dane.obliczenia.cenaKoncowa,
                produkty:zbierzOpisProduktow(dane),
                marzaHandlowca:dane.obliczenia.marzaDlaPH,
                marzaDlaFirmy:dane.obliczenia.marzaDlaFirmy,
                nadprowizjaDyrektora:dane.nadprowizje.dyrektor,
                nadprowizjaKierownika:dane.nadprowizje.kierownik,
                nadprowizjaFirmy:dane.nadprowizje.firma
            })
        })
        .then(r=>r.json())
        .then(resp=>{
            console.log("← odpowiedź GAS:", resp);
            if(resp.result!=='success') alert("Błąd zapisu:\n"+resp.message);
        })
        .catch(err=>{
            console.error("🚨 fetch error:",err);
            alert("Błąd zapisu do arkusza.");
        });
    }

    function generujPDF(typ){
        aktualizujPodsumowanieWizualne();
        if(!daneOferty.klient.imie){
            alert("Wypełnij dane klienta.");
            przejdzDoEtapu(4);
            document.getElementById('klient-imie').focus(); return;
        }
        if(numerZapisanejOferty===null){
            const d=new Date();
            numerZapisanejOferty=`GN/${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}/${String(Date.now()).slice(-4)}`;
            zapiszOferteWArkuzu(daneOferty);
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont('helvetica','normal');
        doc.setFillColor(244,247,246); doc.rect(0,0,210,45,'F');
        doc.setFont('helvetica','bold'); doc.setFontSize(20); doc.setTextColor(0,91,65);
        doc.text(typ==='klient'?"OFERTA HANDLOWA":"PODSUMOWANIE DLA BIURA",105,20,{align:'center'});
        const teraz=new Date();
        doc.setFont('helvetica','normal').setFontSize(10).setTextColor(51,51,51);
        doc.text(`Nr oferty: ${numerZapisanejOferty}`,195,30,{align:'right'});
        doc.text(`Data: ${teraz.toLocaleDateString('pl-PL')}`,195,35,{align:'right'});
        let y=55;
        doc.setFontSize(12).setFont('helvetica','bold').setTextColor(0,91,65);
        doc.text("Nabywca:",20,y); doc.text("Sprzedawca:",110,y);
        doc.setFontSize(10).setFont('helvetica','normal').setTextColor(51,51,51);
        doc.text(daneOferty.klient.imie,20,y+7); doc.text(daneOferty.klient.adres,20,y+12);
        doc.text(daneOferty.klient.kod,20,y+17); doc.text(`Tel: ${daneOferty.klient.telefon}`,20,y+22);
        doc.text(`Email: ${daneOferty.klient.email}`,20,y+27);
        doc.setFont('helvetica','bold').text("GREEN NOW SP. Z O.O.",110,y+7);
        doc.setFont('helvetica','normal').text(`Przedstawiciel: ${daneOferty.handlowiec.imie}`,110,y+12);
        doc.text(`Tel: ${daneOferty.handlowiec.telefon}`,110,y+17);
        doc.text(`Email: ${daneOferty.handlowiec.email}`,110,y+22);
        y+=40;
        const body=[];
        Array.from(document.getElementById('lista-wybranych-elementow').children).forEach((li,i)=>{
            const t=li.textContent,idx=t.indexOf(':');
            body.push([i+1,t.substring(0,idx),t.substring(idx+1).trim()]);
        });
        doc.autoTable({startY:y,head:[['Lp.','Element','Opis']],body,theme:'striped',
            headStyles:{fillColor:[0,91,65],font:'helvetica',fontStyle:'bold'},
            styles:{font:'helvetica',cellPadding:2.5},columnStyles:{0:{cellWidth:10}}
        });
        y=doc.lastAutoTable.finalY+10;
        const { sumaNettoFinal, kwotaVat, cenaKoncowa, marzaDlaPH }=daneOferty.obliczenia;
        const vatProc=(daneOferty.stawkaVat*100).toFixed(0);
        const cenyKl=[['Wartość Netto:',`${sumaNettoFinal.toFixed(2)} PLN`],
            [`Podatek VAT (${vatProc}%):`,`${kwotaVat.toFixed(2)} PLN`],
            [{content:'Wartość Brutto:',styles:{fontStyle:'bold',fontSize:11,fillColor:[224,255,230]}},
             {content:`${cenaKoncowa.toFixed(2)} PLN`,styles:{fontStyle:'bold',fontSize:11,fillColor:[224,255,230]}}]
        ];
        const cenyBi=[
            [{content:'SUMA Netto (dla klienta):',styles:{fontStyle:'bold'}},{content:`${sumaNettoFinal.toFixed(2)} PLN`,styles:{fontStyle:'bold'}}],
            ['Marża dla Handlowca (widoczna):',`${marzaDlaPH.toFixed(2)} PLN`],
            ['Podatek VAT:',`${kwotaVat.toFixed(2)} PLN`],
            [{content:'SUMA Brutto (dla klienta):',styles:{fontStyle:'bold',fillColor:[240,240,240]}},
             {content:`${cenaKoncowa.toFixed(2)} PLN`,styles:{fontStyle:'bold',fillColor:[240,240,240]}}]
        ];
        doc.autoTable({startY:y,body: typ==='klient'?cenyKl:cenyBi,theme:'grid',
            styles:{font:'helvetica'},columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}
        });
        const nazwa=`${typ==='klient'?'Oferta':'Podsumowanie'}_${daneOferty.klient.imie.replace(/[^a-z0-9]/gi,'_')}.pdf`;
        doc.save(nazwa);
    }

    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('przycisk-zaloguj').onclick=()=>{
            if(document.getElementById('haslo-dostepu').value===POPRAWNE_HASLO){
                document.getElementById('prosty-login').classList.add('ukryty');
                document.getElementById('glowny-kalkulator').classList.remove('ukryty');
            } else document.getElementById('login-error-prosty').textContent='Nieprawidłowe hasło!';
        };
        document.getElementById('haslo-dostepu').addEventListener('keyup',e=>{ if(e.key==='Enter') document.getElementById('przycisk-zaloguj').click(); });
        document.querySelectorAll('input,select').forEach(el=>{ el.addEventListener('input',aktualizujPodsumowanieWizualne); el.addEventListener('change',aktualizujPodsumowanieWizualne); });
        document.getElementById('typ-pokrycia').addEventListener('change',()=>{
            aktywnaListaId=null; odswiezWszystkieListy(); aktualizujPodsumowanieWizualne();
        });
        document.querySelectorAll('.lista-produktow').forEach(sel=>sel.addEventListener('change',()=>{
            if(sel.value!=='0'){ aktywnaListaId=sel.id; document.querySelectorAll('.lista-produktow').forEach(o=>{ if(o.id!==sel.id) o.selectedIndex=0; }); }
            else aktywnaListaId=null;
            aktualizujPodsumowanieWizualne();
        }));
        document.getElementById('przycisk-pdf-klient').addEventListener('click',()=>generujPDF('klient'));
        document.getElementById('przycisk-pdf-biuro').addEventListener('click',()=>generujPDF('biuro'));
        odswiezWszystkieListy(); aktualizujPodsumowanieWizualne();
    });
</script>
</body>
</html>
