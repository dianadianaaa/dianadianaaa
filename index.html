<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulator Green Now</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/vfs_fonts.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f4f7f6; color:#333; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; margin:0; padding:20px; box-sizing:border-box;}
    .kontener { background:#fff; padding:40px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); width:100%; max-width:800px;}
    h1,h2,h3 { color:#005b41; text-align:center; }
    .ukryty { display:none; }
    /* … tu cała reszta Twoich stylów, bez zmian … */
  </style>
</head>
<body>
  <div id="prosty-login" class="kontener">
    <h2>Dostęp do kalkulatora</h2>
    <label for="haslo-dostepu">Wprowadź hasło:</label>
    <input type="password" id="haslo-dostepu">
    <button id="przycisk-zaloguj">Odblokuj</button>
    <p id="login-error-prosty" style="color:red; text-align:center; height:20px;"></p>
  </div>

  <div id="glowny-kalkulator" class="kontener ukryty">
    <!-- ETAP 1, ETAP 2 … (bez zmian) -->

    <!-- ETAP 3: PRACE ZIEMNE -->
    <div id="etap3" class="etap ukryty">
      <h2>Krok 3: Prace ziemne i dodatkowe</h2>
      <label for="przekop">Przekop z kablem:</label>
      <select id="przekop">
        <option value="brak" data-price="0">-- Brak --</option>
        <option value="do10" data-price-per-meter="0" data-price="0">Przekop do 10 m</option>
        <option value="10-30" data-price-per-meter="30">Przekop 10–30 m (30 zł/m)</option>
        <option value="30-60" data-price-per-meter="35">Przekop 30–60 m (35 zł/m)</option>
        <option value="powyzej60" data-price-per-meter="0" data-price="0">>60 m (indywidualnie)</option>
      </select>

      <div id="dlugosc-przekopu-kontener" class="ukryty">
        <label for="dlugosc-przekopu">Długość przekopu (m):</label>
        <input type="number" id="dlugosc-przekopu" min="0" value="0">
      </div>

      <!-- dalej ETAP 3 (klimatyzacja, etc.) -->
      <div class="form-buttons">
        <button onclick="przejdzDoEtapu(2)" class="wstecz">&larr; Wstecz</button>
        <button onclick="przejdzDoEtapu(4)">Dalej &rarr;</button>
      </div>
    </div>

    <!-- ETAP 4, PODSUMOWANIE … (bez zmian) -->

  </div>


  <script>
    const POPRAWNE_HASLO       = "ZielonaEnergia2025";
    const SCRIPT_URL_DO_DANYCH = "https://script.google.com/macros/s/AKfycbw0ZsTTqv_7nUPjF765QmpGwTwhZj-bN7e2qM8Xsmp_hNZBOLqiZDut6-VSi67O1DTKpw/exec";

    let daneOferty = {}, numerZapisanejOferty = null, aktywnaListaId = null;

    function przejdzDoEtapu(nr) {
      document.querySelectorAll('.etap').forEach(e=>e.classList.add('ukryty'));
      document.getElementById(`etap${nr}`).classList.remove('ukryty');
    }

    function aktualizujPodsumowanieWizualne() {
      numerZapisanejOferty = null;

      // … zbieranie cen innych elementów …

      // PRZEKOP:
      const selPrzekop = document.getElementById('przekop');
      const inpDlugosc = document.getElementById('dlugosc-przekopu');
      const pricePerM = parseFloat(selPrzekop.selectedOptions[0].dataset.pricePerMeter) || 0;
      const length    = parseFloat(inpDlugosc.value) || 0;
      daneOferty.przekop = {
        text: selPrzekop.selectedOptions[0].text,
        value: selPrzekop.value,
        pricePerMeter: pricePerM,
        length: length
      };
      document
        .getElementById('dlugosc-przekopu-kontener')
        .classList.toggle('ukryty', pricePerM <= 0);

      // … obliczenia kosztów na podstawie daneOferty … i aktualizacja DOM …

    }

    function zapiszOferteWArkuzu(dane) {
      fetch(SCRIPT_URL_DO_DANYCH, {
        method: 'POST', mode: 'cors',
        headers: { 'Content-Type':'application/json;charset=UTF-8' },
        body: JSON.stringify({
          action: 'saveOffer',
          numerOferty: numerZapisanejOferty,
          dataWygenerowania: new Date().toISOString(),
          klient: `${dane.klient.imie}, ${dane.klient.adres}, ${dane.klient.kod}`,
          handlowiec: dane.handlowiec.imie,
          kwotaNetto: dane.obliczenia.sumaNettoFinal,
          kwotaBrutto: dane.obliczenia.cenaKoncowa,
          produkty: [], // tu zbierzOpisProduktow(dane)
          marzaHandlowca: dane.obliczenia.marzaDlaPH,
          marzaDlaFirmy: dane.obliczenia.marzaDlaFirmy,
          nadprowizjaDyrektora: dane.nadprowizje.dyrektor,
          nadprowizjaKierownika: dane.nadprowizje.kierownik,
          nadprowizjaFirmy: dane.nadprowizje.firma
        })
      })
      .then(r=>r.json())
      .then(resp=>{
        if (resp.result!=='success') alert("Błąd zapisu:\n"+resp.message);
      })
      .catch(_=>alert("Krytyczny błąd zapisu do arkusza."));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('przycisk-zaloguj').onclick = ()=>{
        if (document.getElementById('haslo-dostepu').value === POPRAWNE_HASLO) {
          document.getElementById('prosty-login').classList.add('ukryty');
          document.getElementById('glowny-kalkulator').classList.remove('ukryty');
        } else {
          document.getElementById('login-error-prosty').textContent = 'Nieprawidłowe hasło!';
        }
      };

      // podczep wszystkie eventy do inputów/selectów, przyciski, etc.
      document.querySelectorAll('input, select').forEach(el=>{
        el.addEventListener('input', aktualizujPodsumowanieWizualne);
        el.addEventListener('change', aktualizujPodsumowanieWizualne);
      });
    });
  </script>
</body>
</html>
